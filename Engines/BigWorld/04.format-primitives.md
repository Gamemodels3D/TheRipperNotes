# Файлы primitives

Содержат геометрию. Имеют расширение primitives (старый вариант, используется в World of Warplanes) и primitives\_processed (новый вариант, применяется в World of Tanks). Варианты отличаются только набором данных, формат хранения одинаков.

## Формат файлов

Файл начинается с сигнатуры 0x42A14E65 ("eN¡B"). Заголовок файла находится в его конце.

```
PRIMITIVES {
  uint32 magic    // сигнатура файла 0x42A14E65; // "eN¡B"
  byte[] data
  HEADER header
}
```

### Заголовок файла

Содержит информацию о блоках данных.

```
HEADER {
  BLOCK_INFO {
    uint32        size         // размер блока 
    byte[16]      reserved     // неизвестно
    uint32        namelen      // длина имени блока
    char[namelen] name         // имя блока
    byte[]        align        // выравнивание блока кратно 4
  }[]    blocks         // информация о блоках 
  unit32 header_size    // размер заголовка
}
```

Размер каждого элемента blocks выровнен нулями до длины, кратной 4.

## Блоки данных

### Вершины

В новом варианте блок начинается с сигнатуры "BPVT", после которой следует заголовок длиной 64 байта. Возможно строка с завершающим нулём, забитая по ошибке после терминатора мусором.

```
char[4]  magic     // "BPVT"
cstring format     // формат данных
byte[] unknown     // неизвестные данные            
```

Старый вариант этой части не имеет и начинается сразу со следующего заголовка длиной 64 байта. Возможно строка с завершающим нулём, забитая по ошибке после терминатора мусором.

```
cstring formatname    // имя формата
byte[] unknown        // неизвестные данные
```

Теоретически, `formatname` это имя файла в папке *shaders/formats*, в которой описан соответствующий формат хранения данных. К примеру, "set3/xyznuvtbpc" хранится в файле *shaders/formats/set3/xyznuvtbpc.xml* и имеет вид

```xml
<xml>
  <elements>
      <POSITION></POSITION>
      <NORMAL>
          <type>UBYTE4_NORMAL_8_8_8</type>
      </NORMAL>
      <TEXCOORD>
          <type>FLOAT2</type>
      </TEXCOORD>
      <TANGENT>
          <type>UBYTE4_NORMAL_8_8_8</type>
      </TANGENT>
      <BINORMAL>
          <type>UBYTE4_NORMAL_8_8_8</type>
      </BINORMAL>
  </elements>
</xml>
```

Базовая часть `formatname` совпадает с `format.`

### Индексы

В обоих вариантах блоки начинаются с заголовка длиной 64 байта. Возможно строка с завершающим нулём, забитая по ошибке после терминатора мусором.

```
cstring format     // размер индекса "list" 16 бит, "list32" 32 бита
byte[] unknown     // неизвестные данные
```

После чего следует информация о количестве данных

```
unit32 indexNum    // количество индексов
uint32 groupNum    // количество групп
```

Затем следует массив индексов вершин

```
// массив индексов для format == 'list'
uint16[indexNum] index 
// или массив индексов для format == 'list32'
uint32[indexNum] index 
```

Далее хранится информация о группах примитивов

```
{
  uint32 firstIndex    // номер первого индекса в массиве
  uint32 faceNum       // количество примитивов (треугольников)
  uint32 firstVertex   // первый используемый вертекс?
  uint32 vertexNum     // количество задействованных вертексов?
}[groupNum] groups
```

### Другие

Так же встречаются блоки uv2. В старых вариантах есть блоки bsp и bsp\_material.